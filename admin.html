<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard – Predictamind</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="js/cursor-trail.js" defer></script>
    <script src="js/floating-particles.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #222;
            --accent: #1d4ed8;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --bg-gradient: linear-gradient(135deg, #f8f9ff 0%, #eef1f8 100%);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #222;
        }

        .navbar {
            padding: 1.2rem 5%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: #222;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 34px;
            height: 34px;
            background: #222;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .admin-main {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 0 1.5rem;
        }

        /* Login Overlay */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h2 {
            font-family: 'Playfair Display', serif;
            margin-bottom: 2rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            text-align: center;
        }

        .btn-unlock {
            width: 100%;
            padding: 1rem;
            background: #222;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-unlock:hover {
            background: #444;
        }

        /* Dashboard Header */
        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dash-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
        }

        .stat-val {
            font-size: 2rem;
            font-weight: 700;
            display: block;
            margin-top: 5px;
        }

        .stat-lbl {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            overflow: hidden;
        }

        .search-bar {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
            border-bottom: 2px solid #f1f5f9;
        }

        td {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem;
        }

        tr.expandable {
            cursor: pointer;
            transition: 0.2s;
        }

        tr.expandable:hover {
            background: #f8fafc;
        }

        .badge {
            padding: 0.3rem 0.7rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .badge-m {
            color: #1d4ed8;
            background: #dbeafe;
        }

        /* MRI */
        .badge-b {
            color: #b45309;
            background: #fef3c7;
        }

        /* Blink */
        .badge-t {
            color: #15803d;
            background: #dcfce7;
        }

        /* Typing */

        .details-row {
            display: none;
            background: #fbfcfe;
        }

        .details-content {
            padding: 2rem;
            border-left: 4px solid #222;
            font-size: 0.9rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }

        .detail-section h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 0.8rem;
            color: #94a3b8;
        }

        .btn-csv {
            padding: 0.8rem 1.5rem;
            background: #34A853;
            color: white;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.88rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-delete {
            background: none;
            border: 1.5px solid #fca5a5;
            color: #dc2626;
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
            font-size: 0.78rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #fef2f2;
            border-color: #ef4444;
        }

        @keyframes fadeRowOut {
            to {
                opacity: 0;
                transform: scaleY(0);
            }
        }

        tr.deleting {
            animation: fadeRowOut 0.3s ease forwards;
            transform-origin: top;
        }
    </style>
</head>

<body>

    <div id="loginOverlay">
        <div class="login-card">
            <div class="logo-icon" style="margin: 0 auto 1.5rem; width: 60px; height: 60px; font-size: 1.5rem;">P</div>
            <h2>Admin Portal</h2>
            <input type="password" id="adminPass" class="login-input" placeholder="Enter Access Code">
            <button class="btn-unlock" onclick="unlock()">Access Dashboard</button>
        </div>
    </div>

    <nav class="navbar">
        <a href="index.html" class="logo">
            <div class="logo-icon">P</div>Predictamind
        </a>
        <a href="#" class="btn-csv" onclick="exportCSV()">Export CSV</a>
    </nav>

    <main class="admin-main">
        <div class="dash-header">
            <h1>Patient Directory</h1>
            <input type="text" id="patientSearch" class="search-bar"
                placeholder="Search by name, email, or diagnosis..." style="width: 350px; margin-bottom:0;">
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-lbl">Total Patients</span>
                <span class="stat-val" id="count-patients">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-lbl">MRI Visuals</span>
                <span class="stat-val" id="count-mri">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-lbl">Blink Tests</span>
                <span class="stat-val" id="count-blink">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-lbl">Typing Tests</span>
                <span class="stat-val" id="count-typing">0</span>
            </div>
        </div>

        <div class="table-container">
            <table id="patientsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Age/Gender</th>
                        <th>Tests Done</th>
                        <th>Registration Date</th>
                        <th>Details</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="patientsBody">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        let allPatients = [];

        function unlock() {
            if (document.getElementById('adminPass').value === 'admin123') {
                document.getElementById('loginOverlay').style.display = 'none';
                fetchData();
            } else { alert('Incorrect Access Code'); }
        }

        async function fetchData() {
            try {
                const res = await fetch('/get_patients');
                allPatients = await res.json();
                renderTable(allPatients);
                updateStats();
            } catch (e) { alert('Error loading patient data'); }
        }

        function updateStats() {
            document.getElementById('count-patients').textContent = allPatients.length;
            let mri = 0, blink = 0, typing = 0;
            allPatients.forEach(p => {
                mri += p.scans ? p.scans.length : 0;
                blink += p.blink_results ? p.blink_results.length : 0;
                typing += p.typing_results ? p.typing_results.length : 0;
            });
            document.getElementById('count-mri').textContent = mri;
            document.getElementById('count-blink').textContent = blink;
            document.getElementById('count-typing').textContent = typing;
        }

        function renderTable(data) {
            const body = document.getElementById('patientsBody');
            body.innerHTML = '';
            data.forEach(p => {
                const tr = document.createElement('tr');
                tr.id = `row-${p.id}`;
                tr.className = 'expandable';
                tr.onclick = () => toggleRow(p.id);

                const tests = [];
                if (p.scans && p.scans.length) tests.push('<span class="badge badge-m">MRI</span>');
                if (p.blink_results && p.blink_results.length) tests.push('<span class="badge badge-b">Blink</span>');
                if (p.typing_results && p.typing_results.length) tests.push('<span class="badge badge-t">Typing</span>');

                tr.innerHTML = `
                    <td>#${p.id}</td>
                    <td><strong>${p.name}</strong><br><small style="color:#94a3b8">${p.email}</small></td>
                    <td>${p.age} / ${p.gender}</td>
                    <td>${tests.join(' ')}</td>
                    <td>${p.registered_at || '—'}</td>
                    <td style="color:#94a3b8; cursor:pointer" onclick="toggleRow(${p.id})">Details ↓</td>
                    <td><button class="btn-delete" onclick="deletePatient(event, ${p.id}, '${p.name}')">Delete</button></td>
                `;

                const detailTr = document.createElement('tr');
                detailTr.id = `detail-${p.id}`;
                detailTr.className = 'details-row';
                detailTr.setAttribute('colspan-fix', '7');
                detailTr.innerHTML = `
                    <td colspan="7">
                        <div class="details-content">
                            <div class="details-grid">
                                <div class="detail-section">
                                    <h4>MRI Results (${p.scans ? p.scans.length : 0})</h4>
                                    ${renderMRI(p.scans)}
                                </div>
                                <div class="detail-section">
                                    <h4>Blink Tests (${p.blink_results ? p.blink_results.length : 0})</h4>
                                    ${renderBlink(p.blink_results)}
                                </div>
                                <div class="detail-section">
                                    <h4>Typing Speed (${p.typing_results ? p.typing_results.length : 0})</h4>
                                    ${renderTyping(p.typing_results)}
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
                body.appendChild(detailTr);
            });
        }

        function renderMRI(scans) {
            if (!scans || !scans.length) return '<p>No scans uploaded.</p>';
            return scans.map(s => `<div>• Class: <strong>${s.prediction_class}</strong> (${new Date(s.scan_date).toLocaleDateString()})</div>`).join('');
        }
        function renderBlink(results) {
            if (!results || !results.length) return '<p>No data.</p>';
            return results.map(r => `<div>• <strong>${r.blink_count} blinks</strong> in 30s (${new Date(r.created_at).toLocaleDateString()})</div>`).join('');
        }
        function renderTyping(results) {
            if (!results || !results.length) return '<p>No data.</p>';
            return results.map(r => `<div>• <strong>${r.wpm} WPM</strong> / ${r.accuracy}% acc</div>`).join('');
        }

        function toggleRow(id) {
            const row = document.getElementById(`detail-${id}`);
            row.style.display = (row.style.display === 'table-row') ? 'none' : 'table-row';
        }

        async function deletePatient(event, id, name) {
            event.stopPropagation(); // Don't trigger row expand
            if (!confirm(`Delete patient "${name}" and all their test data? This cannot be undone.`)) return;

            try {
                const res = await fetch(`/delete_patient/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Server error');

                // Animate rows out
                const mainRow = document.getElementById(`row-${id}`);
                const detailRow = document.getElementById(`detail-${id}`);
                if (mainRow) { mainRow.classList.add('deleting'); setTimeout(() => mainRow.remove(), 310); }
                if (detailRow) { detailRow.classList.add('deleting'); setTimeout(() => detailRow.remove(), 310); }

                // Update data and stats
                allPatients = allPatients.filter(p => p.id !== id);
                updateStats();
            } catch (e) {
                alert('Failed to delete patient: ' + e.message);
            }
        }

        function exportCSV() {
            let csv = "ID,Name,Email,Age,Gender,Created_At\n";
            allPatients.forEach(p => {
                csv += `${p.id},"${p.name}","${p.email}",${p.age},"${p.gender}","${p.created_at}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `patients_report_${Date.now()}.csv`;
            a.click();
        }

        document.getElementById('patientSearch').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allPatients.filter(p =>
                p.name.toLowerCase().includes(term) ||
                p.email.toLowerCase().includes(term)
            );
            renderTable(filtered);
        };
    </script>
</body>

</html>